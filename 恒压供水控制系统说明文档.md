# 恒压供水控制系统说明文档

------

## 一、HMI接口说明

### 1、基本情况

DB_HMI是人机界面数据的DB，所有和HMI交互的数据都来自于此。DB_HMI采用了1200的复杂数据类型，包括UDT、Array、Struct等等，如果不是采用西门子的HMI则需要对人机界面的数据交互进行移植。（尽管威纶HMI有些型号的设备支持复杂类型，但也只是一部分。）

和DB_HMI交互的DB有两个：DB_Equ和DB_SysLinkOrder，但不是说这两个DB专用于和HMI交互。

DB_Equ中的设备手动调试接口从DB_HMI传过来，包括个接触器的手动启停信号、接触器状态信号：DB_HMI.PxVC和.PxLC<---->DB_Equ.Px.Input。而DB_HMI的泵热继电器信号则从DB_Image从来，原因是热继电器在本系统中是作为变频和工频回路的公共保护元件，**不属于哪个接触器回路**。

泵设备的信号则和DB_SysLinkOrder交互，主要是调试用的系统级指令信号，比如工频启停、切工频等等。这些信号用于调试，在正式投运前可以采取屏蔽措施或是在人机界面中设置相应的操作级别以免操作员未经授权误操作。

处理接口交互的程序块有两个：FC_HMIData和FC_AssOrder。

### 2、如何移植

如果采用的HMI不支持复杂数据类型，则需要另外设计DB，使之只使用基本类型。新DB要求数据和DB_HMI一致，然后设计操作程序替代FC_HMIData和FC_AssOrder。具体设计还需要参看HMI。

## 二、关于从HMI进行设备基本配置的说明

### 1、设备工作模式的配置

从HMI进行水泵是作工作泵还是备用泵的配置操作，这是系统的基本配置途径。作为PLC程序来说做得已经足够完善了，能够应付多种应用变化。比如一般会只有一台备用泵，这主要是从投资、泵房占地空间大小考虑的，也是性价比较高的备用数量，但PLC程序也可以允许有多台备用泵，只要不超过总泵数量就可以。这个显然没有必要，但也可以看出PLC程序的灵活。作为供水系统，特殊要求会有两台备用泵也不足为奇，通常来说工作泵数量这时会有6～8台。

综合考虑了许久，主要是没有一个满意的该步骤HMI操作方法，我还是觉得应该简化配置，不要做成通用性强的设计，改成满足一到两种常规应用的设计。这样设计可以满足绝大多数应用需求，没必要纠结于灵活、通用这些弱需求。这些弱需要不仅实用性较差而且设计也比较麻烦，需要考虑的环节较多。

__配置1__：也是本次设计的系统，有3台泵，需要设置成2用1备。当然还有一台夜用泵，基本和主设计无关，就是定时启停。

首先配置哪台泵做备用泵，定下备用泵后配置2台工作泵的启动顺序。

如果不是这样，按原来的设想做成通用性强的设计，则配置会有很多变化，比如备用泵可以配置1台还是多台，备用泵也可以不配置，也就是没有备用泵。工作泵的数量也有变化，可以剩下的2台作为工作泵，也可以在0备用的情况下3台作为工作泵使用，甚至只有1台工作泵。总之很随意。

问题复杂，变化多端，但未必是有用的。这些好处可能只能在小概率下使用，但付出80%的努力。

_**还是设计好使用性强但只需付出20%精力的功能吧，把剩下的精力用于优化和调试，努力做到强健壮性。**_


## 三、通讯

和ABB ACS510的通讯采用modbus协议，该协议在ABB变频器里面是内置的，不需要另外采购通讯模块。

这次设计的系统采用由变频器自身所带的PID调节器作为PID控制器，不采用PLC作为PID调节器。

通讯需要的数据分两类：输出的控制命令和读取的变频器实时数据。实时数据主要是过程压力值、变频器实时频率值，如果需要还可以有电流值、转矩、累积的运行能耗（千瓦时、兆瓦时）等等。控制命令分两种：一种是变频器的启停命令，一种是PID给定值输出。

如果只是读取变频器的实时数据，并不需要对变频器进行特别的设置就可以，只需要读取输入寄存器值和保持寄存器值。如果需要通过通讯对变频器进行控制则需要对变频器进行适应通讯的设置才可以。

本次设计采用从变频器端子上发信号控制变频器的启停，不通过通讯控制变频器，仅仅通过通讯采集压力值和频率值。目的也很坚定，主要是为了节省成本，不用单独购买S7-1200比较昂贵的模拟量扩展模块。

### 1、通讯缓冲区分配

发送区：发送控制命令的数据区，有变频器启动命令、变频器停止命令，本次设计没有此项内容。但是发送区还应该有PID控制的给定值，所以发送区有至少有一个数据。

接收区：接收变频器AI端子或者保持寄存器的压力值和变频器的实时频率值，共计两个数值。为了留出给以后采集目前没有考虑的信号，我们设计了5个数值的接收区。

























