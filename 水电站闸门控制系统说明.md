# 水电站闸门控制系统的设计说明

本文是2006年离开公司时应熊经理要求做的关于水电站闸门控制系统的说明文件。

>   记得最开始的控制系统是小郭设计的控制柜，有许多的问题，导致PLC程序也变得不理想，但是，我尽量完善了操作。  
>
>   由于当时我正打算辞职，该项目没有完成调试工作。辞职的理由除了个人发展的考虑外更多的是对公司三年来的种种不满，现在想来都很不负责任，心有愧疚。  
>
>   后期还有大约7、8台控制柜是我独立设计的，可惜我没有机会对我设计的产品进行调试了，不知道后面接手的可怜虫会怎么想的。 

## 系统概述

整个控制程序由一个主任务构成，该主任务又由五个彼此独立的功能组成，每个功能根据不同的实现由不等数量的程序段构成。  

1.  Comm功能  
2.  EquDrv功能  
3.  GatePos功能  
4.  Operator功能  
5.  Pressurize功能

***
### 1. Comm功能  
负责把PLC硬点信号（主要是输入信号）镜像到PLC的％m和％mw存储区，以便和HMI通讯。为了统一对PLC输入信号的引用，整个程序当需要引用硬点信号时都尽量引用%m和%mw，而不直接引用%I和%iw。

### 2.EquDrv功能
负责对液压系统所控制的五个设备进行驱动，不涉及设备间的联锁逻辑，只提供外部接口。其中，PrimarySwitch逻辑段完成液压泵组的轮换互备切换。

### 3.GatePos功能
负责闸门开度的计算实现。闸门开度没有直接检测手段，而是通过安装在液压缸顶部的旋转编码器间接提供开度检测信号，需要对编码器原始值进行进一步的计算才能取得闸门的实际开度值。开度值的取得有两种算法，一种是通过闸门安装外形尺寸得出的几何图进一步推算出开度值；一种是比较实用的方法：对开度和编码器码进行一条曲线标定，得出一组折线数据，由这些折线来拟合实际的开度＝f(编码器码)曲线。拟合的方法虽然比较简单，但在某些闸门上不实用，例如如果闸门不是安装在易于手工测量开度的地方，比如地面以下时，就只能用外形尺寸的算法了。这两种算法二取一，通过mask1、mask2这两个bool值屏蔽。具体见程序。为方便对拟合数据进行编辑，设计了编辑数据的自定义功能块GateOpenOperDFB，在Encoder逻辑段中引用到。应该注意的是拟合数据不能少于一对，因为两点才能决能一条线段。当原点从（0，0）开始时，应该把数据作稍微的偏移，例如(0,0.001)，以便程序辨认。当然，也可以修改GateOpenOperDFB以适应这种需求。根据实际联机调试的需要，也可以把这两种算法都使用：大体曲线用外形尺寸计算，局部需要强控制的部分用拟合算法。   这两种算法在实际调试中可能都会遇到编码器码值极性变化的情况，如有可能应该使编码器码值在全开度范围内同极性变化，不要出现中途过零的时候，这需要调整编码器的安装。如果条件不允许调整，应该设计相应的修正算法，将两条直线（指码值－液压杆长度变化是条直线）修正成一条。目前程序里的零点标定功能是在不出现过零变化情况下使用的，实际上可以不用该功能。

### 4.Operator功能
负责提供液压系统外在用户功能，实现了启门闭门逻辑。启门闭门逻辑比较简单：收到命令后在无液压系统故障时启动液压泵组，一段时间后打开建压电磁阀，系统将建立工作压力，等待几秒后打开相应的启门闭门电磁阀。闸门在自动工作时会完成以上逻辑，当无停门命令又收到相应门限位信号时停门，或者中途收到停门命令后执行停门逻辑。停门逻辑是：关闭相应的启门闭门电磁阀，等待几秒后关闭建压电磁阀，又几秒后停止液压泵组。完成停门后闸门停止不动的压力由液压闭锁装置保证。当发生液压站故障时也执行停门逻辑，当然收到紧急停车命令会同时停止所有设备，这由硬接线保证可靠性。    闸门停止在任意中途位置或者停止在最大开度的情况下应该有保持位置的功能：一段时间后闸门由于某种原因出现下滑，下滑超过设定的自复位偏差值（200mm）时执行启门逻辑，当达到先前的位置后自动执行停门逻辑。当闸门下滑偏差超过设定的液压泵切换偏差值（300mm）时执行液压泵切换逻辑：先执行停门逻辑，停顿5秒后执行启门逻辑完成液压泵切换。（液压泵组应该处于轮换状态，程序设定为一次轮换，当需要改变成2次或多次工作后轮换时要修改上述的闸门复位液压泵自动切换逻辑，不能简单地把计数器预定值改成2或3）。  当偏差超过设定的400mm时停门并发出报警信号，此时液压系统可能出现问题需要维护。      龙马电站的系统由于硬接线问题，建压电磁阀是和液压泵同时工作的。

### 5.Pressurize功能
负责水封系统的实现。由于是和液压相对独立的系统，把水封单独作成一个功能，其自身的联锁比较简单，但需要和夹江的工程师了解联锁关系。水封和液压系统也有联锁关系，需要完成水封后实现，也需要向夹江的工程师咨询。目前水封只提供框架程序。

## 调试注意事项

***
### 1.
由于液压站没有处于可工作状态，一些故障信号存在（油温高、油位高），需要力士乐处理。柜内我把三个中继拔下来了（油温高、油位高、系统压力低的信号引入中继）。

### 2.
液压缸压力模拟信号现场接线可能会不正确，有可能是三线制压力变送器，需要改柜内接线。柜内的模拟信号接线小郭没有设计图纸，是在车间调试时改的。

### 3.
编码器信号可能会出现不正确的情况，需要液压杆运动后才能知道。  联机后查看编码器原始码是否存在，可从Unity设备配置视图看，也可从HMI的系统配置参数看。如果原始码是0，证明编码器的编程部分有需要完善的地方，主要是断电后计数模块CTY2C认为现场编码器电源中断，保留了故障信号，需要确认故障。已经编程实现了自动确认故障，并且也屏蔽了该故障，只是我没有使用过编码器的经验，需要多关注。

### 4.
液压杆运行后需要观察编码器码值的变化是否有序，如果出现乱变化的情况，证明编码器数据接线错误，需要改正。主要是现场接线的数据顺序是否正确？（数据由一根屏蔽14芯和一根没有屏蔽的的7芯电缆连接，由于14局没有两根屏蔽电缆，我在柜内也没有作屏蔽接地处理。加上电缆没有走最近的线路敷设，可能会过长导致二进制信号传输失真）。如果接线顺序正确但还是数据不对就把16根数据线倒过来重新排序接线。只需要调换一边的接线顺序就可以了。例如：原来是1、2、3、…….15、	16，现在变成16、15、…..2、1的接线顺序。15、16位是没有屏蔽的那根电缆的1、2号芯线。

>**后记：**编码器应该采用的是绝对值编码器，其中常州力士乐配套项目采用施耐德专用计数模块来做，其他项目采用普通的离散输入模块来做。PLC的配置由液压厂提供，应该计数速率不会太快，否则不会采用普通IO模块。

### 5.
由于一开始动液压杆时没有确定编码器值是否正确，加上闸门没连接也没有安装开度限位，所以最好用单步功能调试。如果用单机手动功能，程序没有故障联锁停机功能，需要注意液压故障信号。   一开始系统压力低信号会出现，但不影响启门闭门。检测系统压力高低故障在打开建压阀后才检测。启门中检测有杠腔压力是否过高，闭门检测无杠腔压力是否过高。影响开机的故障信号只有油箱故障信号：油位高低、油温高低、过滤器堵塞，出现这些信号不能启动系统。调试可能会屏蔽一些故障信号。

### 6.
根据调试结果可能需要调整故障检测启动时间，在Alarm段调整。  系统报警铃和报警灯组成的报警系统设计不合理，可能会对调试心里造成影响。   

***
盘柜需要整改的地方：标牌、水封的指示灯。水封指示灯调试时出现几个不相干的灯点亮的情况，经检查是感应电影响，但220VAC的指示灯在48VAC左右就被点亮我怀疑施耐德的这些指示灯质量有问题。  
关于程序逻辑具体如何构建，每个逻辑变量是什么含义的问题没有讨论价值。每个人对系统的构建思想不一样，讨论起来比较费劲。我的思路是从功能着手逐步细化，当然，大家也都是从功能着手的。不过每个人对功能的认识不一样，也就是说功能和功能对于每个人有不一样的含义，没有对错之分，只有高低之别。